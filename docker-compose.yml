# docker-compose.yml
services:
  # ----------------------------------------------------
  # 1. RUST WS HUB (Port 3100)
  # ----------------------------------------------------
  rust_backend:
    build:
      context: .
      dockerfile: Dockerfile.rust
    container_name: rust_ws_hub
    ports:
      - "3100:3100"
    restart: always
    volumes:
      - ./shared:/app/shared
    environment:
      RUST_LOG: info

  # ----------------------------------------------------
  # 2. FASTAPI AUTOMATION GATEWAY (Port 8000)
  # ----------------------------------------------------
  fastapi_automation:
    build:
      context: .
      dockerfile: Dockerfile.fastapi
    container_name: fastapi_gateway
    ports:
      - "8000:8000"
    depends_on:
      - rust_backend
    restart: always
    environment:
      RUST_WS_URL: ws://rust_backend:3100/ws

  # ----------------------------------------------------
  # 3. FRONTEND (React/Vite)
  # ----------------------------------------------------
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: frontend_app
    ports:
      - "5173:5173"
    depends_on:
      - rust_backend
      - fastapi_automation
    # Expose the dev server to the Docker host for browser access
    command: npm run dev -- --host 0.0.0.0
    environment:
      # Keep the WS URL for the automation streaming connection
      VITE_RUST_WS_URL: ws://127.0.0.1:3100/ws 
      
      # Use the Rust HTTP URL for MegaMenu fetching
      VITE_RUST_HTTP_URL: http://127.0.0.1:3100 # New explicit variable for clarity
      
      # Keep the FastAPI URL for the trigger POST
      VITE_API_GATEWAY_URL: http://127.0.0.1:8000
