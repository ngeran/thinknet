services:
  # --- Main cRPD Container ---
  crpd:
    image: ${CRPD_IMAGE_NAME}:${CRPD_TAG}
    container_name: juniper-crpd
    hostname: crpd-lab
    privileged: true
    tty: true
    stdin_open: true
    networks:
      lab-net:
        ipv4_address: 10.99.1.10
    volumes:
      - ./configs:/config
      - ./scripts:/scripts
      - ./license:/config/license
      - crpd-persist:/var/crpd
    ports:
      # HOST_PORT : CONTAINER_PORT
      - "2222:22"    # SSH mapped to avoid host conflict
      - "8830:830"  # NETCONF mapped
      - "5000:5000" # Generic
    environment:
      - TZ=UTC
    restart: unless-stopped
    profiles: [ "run-crpd" ]
    command: >
      sh -c "
        # Apply configuration if it exists
        if [ -f /config/crpd.conf ]; then
          cp /config/crpd.conf /etc/crpd.conf;
        fi;
        # Check for license (placeholder logic)
        if [ -f /config/license/juniper.lic ]; then
           echo 'License file detected...';
        fi;
        # Start the Routing Process Daemon
        /sbin/rpd -c /etc/crpd.conf -v --log-level=info
      "

  # --- Initialization Helper ---
  # Prints access credentials to the log after startup
  crpd-init:
    image: alpine
    container_name: crpd-init
    networks:
      lab-net:
        ipv4_address: 10.99.1.99
    profiles: [ "init" ]
    depends_on:
      - crpd
    command: >
      sh -c "
        sleep 10;
        echo '=============================================';
        echo 'üöÄ cRPD Lab is RUNNING!';
        echo 'üì° Internal IP:   10.99.1.10';
        echo 'üîë Default Creds: root / Juniper123';
        echo 'üíª SSH Access:    ssh root@localhost -p 2222';
        echo '=============================================';
      "

  # --- Status Checker ---
  # Can be run manually to verify internal connectivity
  crpd-status:
    image: alpine
    container_name: crpd-status
    profiles: [ "status" ]
    depends_on:
      - crpd
    command: >
      sh -c "
        apk add --no-cache netcat-openbsd;
        echo '=== cRPD Connectivity Check ===';
        if nc -z crpd 22; then
          echo '‚úÖ cRPD is reachable on internal port 22';
        else
          echo '‚ùå cRPD is NOT reachable';
        fi;
      "

networks:
  lab-net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.99.1.0/24

volumes:
  crpd-persist:
    driver: local
